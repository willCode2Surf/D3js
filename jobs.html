<!DOCTYPE html>
<meta charset="utf-8">
<title>Radiator</title>
<style>
	.Job {
		stroke: #000;
	}
	
	.Test {
		fill: #ff0000;
	}
</style>

<header>
	<aside>Radiator</aside>
</header>

<p id="radiator"></p>

<script src="http://d3js.org/d3.v2.js?2.8.1"></script>

<script>
var	margin = {top: 20, right: 20, bottom: 20, left: 100},
width = 960 - margin.left - margin.right,
height = 500 - margin.top - margin.bottom;

function x(d) { return 0.5; }
function y(d) { return 0.5; }
function w(d) { return .5; }
function h(d) { return .5; }
function age(d) { return 1; }
function color(d) { return 1; }

var xScale = d3.scale.linear().domain([0, 1]).range([0, width]),
	yScale = d3.scale.linear().domain([0, 1]).range([height, 0]),
	widthScale = d3.scale.linear().domain([0, 1]).range([0, width]),
	heightScale = d3.scale.linear().domain([0, 1]).range([0, height]),
	colorScale = d3.scale.category10();

var svg = d3.select("#radiator")
	.append("svg")
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
	.append("g")
	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

//var test = svg.append("rect")
//	.attr("class", "Test")
//	.attr("x", xScale(0))
//	.attr("y", yScale(1))
//	.attr("width", widthScale(1))
//	.attr("height", heightScale(1));

// Load the data.
d3.json("./jobs.php", function(Jobs) {
	
	var Revisions = new Array();
	var z = new Array();

	Jobs.map(
		function(d) {
			d.Date = new Date(1000*d.Date);

			var i = z.indexOf(d.Revision);
			if (i<0) {
				i = z.push(d.Revision) - 1;
				var Revision = {
					Revision: d.Revision,
					Jobs: new Array()
				};
				Revisions.push(Revision);
			}
			Revisions[i].Jobs.push(d);
		}
	);
//	alert(z);
//	alert(Revisions[1].Jobs[0].Name);
//	alert(Revisions[1].Jobs[1].Name);
	var RevisionCount = Revisions.length;
	var JobCount = 0;
	Revisions.map(
		function(d) {
			JobCount = Math.max(JobCount, d.Jobs.length);
		}
	);
	alert(RevisionCount);
	alert(JobCount);

	xScale.domain([0, JobCount]);
	yScale.domain([0, RevisionCount]);

	var Jobs = svg.append("g")
		.selectAll(".Job")
		.data(Jobs)
		.enter().append("rect")
		.attr("class", "Job")
		.style("fill", function(d) { return colorScale(color(d)); })
		.call(position)
		.sort(NewestOnTop);

	function position(Job) {
		Job	.attr("x", function(d) { return xScale(x(d)); })
			.attr("y", function(d) { return yScale(y(d)); })
			.attr("width", function(d) { return widthScale(w(d)); })
			.attr("height", function(d) { return heightScale(h(d)); });
	}

	function NewestOnTop(a, b) {
		return age(b) - age(a);
	}

//	 Jobs.append("title")
//		.text(function(d) { return "Title"; });
});

</script>