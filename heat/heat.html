<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Heat Map</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	
		<link href="css/styles.css" rel="stylesheet" type="text/css" />
	
	<script type="text/javascript" src="js/data.js"></script>
	<script type="text/javascript" src="js/data_time_series.js"></script>
	<script type="application/x-javascript" src="../../../public/mbostock-d3/d3.v2.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
	<script src="js/global.js" type="text/javascript"></script>
	
	<link rel="stylesheet" href="css/uniform.default.css" type="text/css" media="screen" charset="utf-8" />
	<script src="js/jquery.uniform.js" type="text/javascript"></script>
	
	<link rel="stylesheet" href="css/styledButton.css" type="text/css" media="screen" charset="utf-8" />
	<script src="js/jquery.styledButton.js" type="text/javascript"></script>
	
<!--	<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow' rel='stylesheet' type='text/css'>-->
<!--	<link href='http://fonts.googleapis.com/css?family=Cardo' rel='stylesheet' type='text/css'>-->
</head>

<body>
	<h1 style="padding-top:10px">Telco Dashboard</h1>
	<div style="width:3000px;position:relative;left:50px">
		<div id="visualization_container2" class="visualization_container" style="display:inline-block">
			<div id="visualization2" class="visualization">
			</div>
		</div>
		<div id="scrollPaneContent2" class="scrollPaneContent" style="display:inline-block">
		</div>
	</div>
	<div style="width:1000px;position:relative;left:50px">
		<div id="msgs"></div>
		<div id="visualization_container" class="visualization_container" style="display:inline-block">
			<div id="visualization" class="visualization">
			</div>
		</div>
		<div id="scrollPaneContent" class="scrollPaneContent" style="display:inline-block">
		</div>
	</div>

	
	<script type="text/javascript">
		function checkAll(field) {
			for (i = 0; i < field.length; i++) {
				$(field[i]).attr('checked','checked');
				$.uniform.update();
			}
		}

		function uncheckAll(field) {
			for (i = 0; i < field.length; i++) {
			$(field[i]).removeAttr('checked');
				$.uniform.update();
			}
		}

		var TOTAL_STUDENTS = 38;
		var w = 1000,
		h = 500,
		p = 16,
		x = d3.scale.linear().range([0, w]).domain([-1,14]),
		y = d3.scale.linear().range([200, 100]).domain([5,1]),
		colScale = d3.scale.linear().range([0, w]).domain([-1,14]),
		rowScale = d3.scale.linear().range([200, 100]).domain([5,1]),
		widthScale = d3.scale.linear(),
		heightScale = d3.scale.linear();
		sizeScale = d3.scale.pow().exponent(0.5);
	
		symbol = d3.scale.ordinal().range(d3.svg.symbolTypes),
		//color = d3.scale.category20c();
		//color = d3.scale.ordinal().range(["#774F38","#E08E79","#F1D4AF","#ECE5CE","#C5E0DC"]); //nice one
		//color = d3.scale.ordinal().range(["#774F38","#E08E79","#ECE5CE"]);
		//color = d3.scale.ordinal().range(["#444546","#C11515","#9E9E9E","#FFAB19","#0B486B"]);
		//color = d3.scale.ordinal().range(["#556270","#4ECDC4","#C7F464","#FF6B6B","#C44D58"]);
		color = new Array("#424254","#E8CAA4","#64908A");
	
		var vis = d3.select("#visualization")
			.append("svg:svg")
				.attr("width", w + p * 2)
				.attr("height", h + p * 2)
			.append("svg:g")
				.attr("transform", "translate(" + p + "," + p + ")");

		var xrule = vis.selectAll("g.x")
			.data(x.ticks(12))
			.enter().append("svg:g")
			.attr("class", "x")
			.style("stroke","#dbdbdb");

		var yrule = vis.selectAll("g.y")
			.data(y.ticks(5))
			.enter().append("svg:g")
				.attr("class", "y")
		;

		yrule.append("svg:line")
			.attr("x1", 0)
			.attr("x2", w)
			.attr("y1", y)
			.attr("y2", y)
		;

		//the rectangle surrounding the plot
		vis.append("svg:rect")
			.attr("width", w)
			.attr("height", h);

		assignEventListeners();
		setContent('by_category');
		
		d3.csv("./telco.csv", function(data) {
			console.log(data);
			var layout = data.shift();
			var formats = data.shift();
			
			var dimensions = {
				names: new Array(),
				objects: new Array()
			};
			var metrics = {
				names: new Array(),
				objects: new Array()
			};
			var base = {
				name: null
			};
			for (i in layout) {
				switch (layout[i]) {
					case "M":
						metrics.names.push(i);
						metrics.objects.push({
							name: i,
							max: 0,
							scale: d3.scale.pow().exponent(0.5),
							format: formats[i]
						});
						break;
					case "D":
						dimensions.names.push(i);
						dimensions.objects.push({
							name: i,
							valueNames: new Array(),
							valueObjects: new Array()
						});
						break;
					case "B":
						base.name = i;
						break;
				}
			}
			console.log(metrics);
			
			dimensions.objects.forEach(function(dimension, i) {
				data.forEach(function(d) {
					if (d[dimension.name]!="*") {
						if (dimension.valueNames.indexOf(d[dimension.name])<0) {
							dimension.valueNames.push(d[dimension.name]);
							dimension.valueObjects.push({
								name: d[dimension.name]
							});
						}
					}
				});
			});
			console.log(dimensions);

			var vis = d3.select("#visualization2")
				.append("svg:svg")
					.attr("width", w + p * 2)
					.attr("height", h + p * 2)
				.append("svg:g")
					.attr("transform", "translate(" + p + "," + p + ")")
			;

			var selectedDimension = "Market";
			var rowData = dimensions.objects[dimensions.names.indexOf(selectedDimension)].valueObjects;
			var rowNames = dimensions.objects[dimensions.names.indexOf(selectedDimension)].valueNames;
			var colData = metrics.objects;
			var colNames = metrics.names;
			
			//Rows
			var rows = vis.selectAll("g.row")
				.data(rowData)
				.enter().append("svg:g")
					.attr("class", "row")
			;
			//Columns			
			var cols = vis.selectAll("g.col")
				.data(colData)
				.enter().append("svg:g")
					.attr("class", "col")
			;
			
			rowlabels = rows.append("svg:text")
				.style("text-anchor", "end")
			;
			collabels = cols.append("svg:text")
				.style("text-anchor", "middle")
			;

			rowlabels
				.append("tspan")
				.text(function(d) {return d.name;})
			;
			collabels
				.append("tspan")
//				.text(function(d) {return d;})
				.text(function(d) {return d.name;})
			;
			
			var maxRowTextWidth = 0;
			rowlabels
				.each(function(d) {
					d.BBox = this.getBBox();
					maxRowTextWidth = Math.max(maxRowTextWidth, d.BBox.width);
			})
			var maxColTextHeight = 0;
			rowlabels
				.each(function(d) {
					d.BBox = this.getBBox();
					maxColTextHeight = Math.max(maxColTextHeight, d.BBox.height);
			})

			rowScale.domain([-1, rowData.length]).range([maxColTextHeight, h]);
			heightScale.domain([-1, rowData.length]).range([0, h - maxColTextHeight]);
			var	rowSpacing = heightScale.range().pop()/(rowData.length+1),
				rowLabelMargin = 10;

//			colScale.domain([-1, colData.length]).range([maxRowTextWidth, w]);
//			widthScale.domain([-1, colData.length]).range([0, w - maxRowTextWidth]);
			widthScale.domain([0, colData.length-1]).range([0, w - maxRowTextWidth]);
			var	colSpacing = widthScale.range().pop()/(colData.length),
			gridSize = Math.min(rowSpacing, colSpacing);
			colScale.domain([0, colData.length-1]).range([maxRowTextWidth+rowLabelMargin+rowSpacing, w-rowSpacing]);


			rowlabels
				.attr("x", colScale(-rowSpacing/colSpacing)-rowLabelMargin)
				.attr("dy", "0.5ex")
			;
			
			rows.append("svg:line")
				.attr("x1", colScale(-rowSpacing/colSpacing))
				.attr("x2", colScale(colData.length))
			;
			
			rows
				.attr("transform", function(d, i) {return "translate(0," + rowScale(i) + ")";})
			cols
				.attr("transform", function(d, i) {return "translate(" + colScale(i) + ",0)";})

			cols.append("svg:line")
				.attr("y1", rowScale(-1))
				.attr("y2", rowScale(rowData.length))
			;

			if (false) {
				vis.append("svg:g")
					.attr("class", "border")
					.attr("transform", function(d, i) {return "translate("+colScale(-1)+"," + rowScale(-1) + ")";})
					.append("svg:rect")
						.attr("width", widthScale(colData.length))
						.attr("height", heightScale(rowData.length))
				;
			}

			//Have the grid now
//			var gridSize = Math.min(widthScale.range().pop()/(colData.length+1), heightScale.range().pop()/(rowData.length+1));
			
			function isVisible(d) {
				return d[selectedDimension] != "*";
			}

			function visibleMetrics(metricObject) {
				switch (metricObject.name) {
					case "AHT":
					case "Calls 2 Resolve":
					case "NPS":
					case "Attrition Likelihood":
					case "% Upsell":
						return true;
						break;
					default:
						return false;
				}
			}

			var	grid = new Array();
			data.filter(isVisible).forEach(function(data) {
				metrics.objects.filter(visibleMetrics).forEach(function(metricObject) {
					value = data[metricObject.name]/data[base.name];
					switch (metricObject.format) {
						case "%":
							formattedValue = Math.round(100*value)+"%";
							break;
						default:
							formattedValue = value;
					}
					metricObject.max = Math.max(metricObject.max, value);
					grid.push({
//						d: d["Call Reason"],
//						m: metrics.names[0],
//						v: data[metricObject.name],
						y: rowNames.indexOf(data[selectedDimension]),
						x: colNames.indexOf(metricObject.name),
						v: value,
						f: formattedValue
					});
				});
			});
//			sizeScale.domain([0, maxValue]).range([0, gridSize/2]);
//			sizeScale.domain([0, 150]).range([0, gridSize/2]);
			console.log(Number("50"));

			metrics.objects.filter(visibleMetrics).forEach(function(metricObject) {
				metricObject.scale.domain([0, metricObject.max]).range([0, gridSize/1.5]);
			});
				
			var cells = vis.selectAll("svg.cell")
				.data(grid)
				.enter().append("svg:g")
					.attr("class", "cell")
					.attr("transform", function(d) {return "translate("+colScale(d.x)+","+rowScale(d.y)+")";})
			;
			
			cells
				.append("svg:circle")
			    	.transition()
				    	.delay(0)
				        .duration(800)
						.attr("r", function(d) {return metrics.objects[d.x].scale(d.v);})
			;
			cells
				.append("svg:text")
					.style("text-anchor", "middle")
					.attr("dy", "0.5ex")
					.text(function(d) {return d.f;})
			;

			//***************
			
			var content = "";
			dimensions.objects.forEach(function(dimension) {
				if (dimension.name != selectedDimension) {
					content += "<div style='float:left;padding-right:10px;padding-top:10px;'>";
					content += "<span class='categoryTitle'>"+dimension.name+"</span><br />";
					content += "<div style='border-left:2px solid #f24254;position:relative;left:1px;top:0'>";
					content += "<label><input type='checkbox' class='xcontrol_select_all' id='all_"+dimension.name+"' style='vertical-align: middle; margin: 0px' /> Visualize all</label><br />";
		
					for(i=0;i<dimension.valueObjects.length;i++) {
						content += "<label><input type='checkbox' name='control_seaters' class='control' id='" + dimension.valueObjects[i].name + "' /> <span id='text_" + dimension.valueObjects[i].name + "'>" + dimension.valueObjects[i].name + "</span></label><br />"
					}
					content += "</div></div>";
				}
				
			});
			$("#scrollPaneContent2").html(content);
			$("input:checkbox").uniform();
			$(".xcontrol_select_all").click();
			
		});


	</script>
	
	</div>
  </body>
</html>