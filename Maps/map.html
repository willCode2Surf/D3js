<!DOCTYPE html>
<html>
	<head>
		<meta name="Austin Addresses" content="initial-scale=1.0, user-scalable=no"/>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
		<script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?1.29.1"></script>
		<style type="text/css">

html, body, #map {
	width: 100%;
	height: 100%;
	margin: 0;
	padding: 0;
}

.addresses, .addresses svg {
	position: absolute;
}

.addresses svg {
	width: 60px;
	height: 30px;
	padding-right: 100px;
	font: 10px sans-serif;
}

.addresses circle {
	fill: red;
	stroke: black;
	stroke-width: 0.5px;
}

.addresses text {
	font-family: "Helvetica Neue", Helvetica, sans-serif;
	font-weight: 400;
	stroke: #ff0000;
	fill: #ff0000;
	letter-spacing: 1px;
	margin: .3em 0 .1em 0;
}

		</style>
	</head>
	<body>
		<div id="map"></div>
		<script type="text/javascript">

// Create the Google Map…
var map = new google.maps.Map(d3.select("#map").node(), {
	zoom: 11,
	center: new google.maps.LatLng(30.35, -97.7),
	mapTypeId: google.maps.MapTypeId.TERRAIN
});

//var traffic = new google.maps.TrafficLayer();
//traffic.setMap(map);

//var transit = new google.maps.TransitLayer();
//transit.setMap(map);

//var bicycle = new google.maps.BicyclingLayer();
//bicycle.setMap(map);

var CircleRadiusScale = d3.scale.pow().exponent(3).domain([0, 15]).range([1, 7]);
var TextSizeScale = d3.scale.pow().exponent(3).domain([0, 15]).range([1, 25]);

// Load the address data.
d3.json("addresses.json", function(data) {
	
	var overlay = new google.maps.OverlayView();

  // Add the container when the overlay is added to the map.
	overlay.onAdd = function() {
		var layer = d3.select(this.getPanes().overlayLayer).append("div")
			.attr("class", "addresses");

		overlay.draw = function() {
			var	projection = this.getProjection(),
				padding = 15;

			var newMarkers = layer.selectAll("svg")
				.data(data)
				.enter().append("svg:svg")
				.attr("class", "marker")
			;
			newMarkers.append("svg:circle");
			newMarkers.append("svg:text");
			
			var markers = layer.selectAll("svg")
				.each(transformPosition)
			;
			
			markers.selectAll("circle")
				.attr("r", function(d) {return CircleRadiusScale(map.getZoom());})
				.attr("cx", padding)
				.attr("cy", padding)
			;

			markers.selectAll("text")
				.attr("x", padding + 7)
				.attr("y", padding)
				.attr("dy", ".31em")
				.style("font-size", function(d) {return TextSizeScale(map.getZoom());})
				.text(function(d) { return d.name; })
			;

			function transformPosition(d) {
				coordinates = projection.fromLatLngToDivPixel(d.LatLng);
				d3.select(this)
					.style("left", (coordinates.x - padding) + "px")
					.style("top", (coordinates.y - padding) + "px");
			}
		};
	};


	var geocoder = new google.maps.Geocoder();
	data.map(function(d, i) {
		geocoder.geocode({address: d.address}, function(r,s) {
			data[i].LatLng = new google.maps.LatLng(r[0].geometry.location.lat(), r[0].geometry.location.lng());
			if (i == data.length - 1) {
				//Now that whole array has been updated with lat and lng, bind the overlay to the map.
				overlay.setMap(map);
			}
		});
	});
});

		</script>
	</body>
</html>